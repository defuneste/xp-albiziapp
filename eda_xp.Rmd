---
title: "EDA_XP"
author: "Olivier Leroy"
date: "12 août 2019"
output: 
  bookdown::html_document2:
    toc: TRUE
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("chargement_xp.R")
## chargement des libraries
library(ggplot2)
library(bookdown)
library(sf)
library(ggmap)
library(tmaptools)
library(spatstat)
```


# Présentation du test 

Le test a eu lieu le samedi 29 juin 2019 de 10h30 à 12h00 et regroupait 7 participants. 125 arbres (relevés) ont été effectués entre les participants (figure \@ref(fig:releveactivite)). Le nombre de relevés par participant varie de 10 à 40 arbres. 

## Zone de test

### Localisation et limite de la zone de test

La zone du test (figure : \@ref(fig:zonetest)) a eu lieu à Saint-Etienne dans le quartier Carnot. Elle est délimitée au nord par le campus de Manufacture de l'Université Jean Monet, à l'est par le boulevard Thiers, à l'ouest par la ligne de tramway et au sud par le boulevard Jules Janin. Ce sont des axes simples à reconnaître même pour quelqu'un de non familier de la zone. 

```{r zonetest, fig.align = 'center', echo=FALSE, message=FALSE, fig.cap="Carte de présentation de la zone de test"}
load(file = "data/xp_st_e.RData")
xp_st_e +
  geom_sf(data = arbre_xp_zone.shp, inherit.aes = FALSE, pch = 16, alpha = 0.7, aes(col = "forestgreen"), size = 0.5, show.legend = "point") +
  geom_point(aes(x = 4.3860717, y = 45.4496287), size = 4, pch = "M") +
  xlab("") + ylab("") +
  labs(caption = "Fonds OSM, rendu Stamen") +
  scale_color_manual(values = c("forestgreen" = "forestgreen"), name = "", labels = "Arbres préalablement identifiés")
```

L'endroit est entièrement couverte par un wifi et dispose de prises de chargement de portables en accès libre. 

### Arbres de la zone de test

Cette zone représente `r round(st_area(zone.shp)/10000, 2)` h. Elle comprend `r nrow(arbre_xp_zone.shp)` arbres soit `r round(nrow(arbre_xp_zone.shp)/round(st_area(zone.shp)/10000, 2),2)` arbres par hectare. 

Il y a entre 41 et 42 genres d'arbres (en fonction d'où on range les macromeles). Prés de 50% des arbres se retrouvent être soit des *Platanus* (une seule espèce) soit des *Prunus* (6 espèces). 62 espèces se répartissent dans ces genres. 

Les arbres sont en moyennes à 5,53 m les uns des autres, avec une médiane de 5,35 m et pour 90% des arbres cette distance est comprise entre 1,75 et 9,73 m. 
(note olivier, au regard des activités il serait bon de regarder la distance au prochain genre différents)

## Les 5 activités

Il y a eu 5 activités de proposés : 

* 1 : "Faites 5 relevés"
* 2 : "Faites 3 relevés de genres différents" 
* 3 : "Vérifiez 3 relevés d'un autre utilisateur (cercle vert clignotant)"
* 4 : "Identifiez 3 relevés d'expert (cercle bleu clignotant)"
* 5 : "Faites un maximum de relevé en un temps limite"

Il était aussi possible de faire un relevé hors activité (6). 

Les activités 1 et 2 demandent un nombre précis de relevés pour être validés (respectivement 5 et 3). 

```{r releveactivite, fig.align = 'center', echo = FALSE, fig.cap="Nombre de reĺevés par participants en fonction des activités"}
ggplot(data = xp_bota.shp, aes(x = Participant)) +
  geom_bar(aes(fill = code_activ)) + # penser à changer la couleur
  labs(x ="Participants",
       y ="Nombre de relevés") +
  scale_fill_discrete(name = "Activités") +
  theme_bw() +
  theme( 
    panel.grid.major.x = element_blank() # ici c'est juste pour supprimer les lignes verticales
  )
```


## Travail sur les données 

### Travail non effectué 
Pour le moment aucun travail sur l'emplacement exacte des arbres n'a pas été mené. 


### Validation genre et espèce

La vérification des genres et espèces c'est fait dans un premier temps à l'aide d'un SIG "bureau" en comparant le relevé de l'utilisateur à ce que nous connaissions via la base de données. Dans le cas de doute, relevé loin d'un arbre pouvant correspondre, erreur peu probable (espèce vraiment différente) nous sommes allés directement sur le terrain pour vérifier. Cela correspondait à `r sum(!is.na(xp_bota.shp$verif))` cas (une mâtinée de travail). Dans ces cas la photo fût aussi utiliser et fût d'une aide précieuse.

Les platanes ont aussi été validés comme "bon" largement : "Platane hybride", "Platane occidentale" etc.. sont considérés valides (c'est peu être trop laxiste).

`bota` est le champs correspondant à l'exactitude de l'information botanique. Il peut prendre les valeurs de :

* 0 : une erreur d'identification
* 1 : le genre est présent et bon
* 2 : genre et non commun présents et bons
* 3 : genre / non commun / espèce de présents et bon (si j'avais le nom latin j’estimais que c’était bon)
* 4 : genre bon mais reste mauvais
* 5 : "Nom commun de bon"  
* 6 : genre et non latin de bon

J'avais fait une seule variable car j'avais l'impression de forte corrélation, mais au final c'est plus simple de faire plusieurs variables (tout en gardant en tête une  éventuelle corrélation).

Pour simplifier un recodage par info à été fait : 

* `bota_commun` : 0  = faux (`bota` = 0, 1, 4, 6) et 1 bon (`bota` = 2, 3 ou 5) et NA si pas d'info (ne devrait-on pas mettre 0 ?)
* `bota_genre` : 0 = faux et (`bota` = 0, 5) 1 bon (`bota` = 1, 2, 3, 4 et 6) et NA si pas d'info
* `bota_especie` :  0 = faux et 1 bon (`bota` = 3) et NA si pas d'info

`Ajout` : correspond à un arbre non présent dans la base, que les participants ont trouvé et qui existe bien. Attention, il est aussi possible que cela soit des arbustes qui sont problématiques dans la définition d'un arbre.  

# Premiers résultats 

```{r, fig.align = 'center', echo = FALSE, fig.cap="Tableau de présentation "}
tableau_participants <- xp_bota.shp %>%  
  st_set_geometry(value = NULL) %>%  # on drop la geométrie
  group_by(Participant) %>% # on groupe par participants
  summarise(nb_releve = n(), # nombre de nouvelles observations par participants
            nb_genre = sum(!is.na(common)), # nombre de nom commun renseignés 
            nb_commun = sum(!is.na(genus)), # nombre de genre renseignés
            nb_espece = sum(!is.na(specie)) # nombre d'especes latin renseigné
            ) 
library(knitr)
kable(tableau_participants)
```



